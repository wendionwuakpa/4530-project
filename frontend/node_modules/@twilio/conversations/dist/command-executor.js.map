{"version":3,"file":"command-executor.js","sources":["../src/command-executor.ts"],"sourcesContent":["import { TransportResult as Result, Transport } from \"twilsock\";\nimport { MutationConflictResponse } from \"./interfaces/commands/mutation-conflict\";\nimport { v4 as uuidv4 } from \"uuid\";\nimport { AsyncRetrier } from \"@twilio/operation-retrier\";\n\nexport interface CommandExecutorServices {\n  transport: Transport;\n}\n\nconst trimSlashes = (url: string): string => url.replace(/(^\\/+|\\/+$)/g, \"\");\n\nconst isMutationConflictResponse = (\n  response: Result<unknown>\n): response is Result<MutationConflictResponse> => response.status.code === 202;\n\n/**\n * Reason for why retrier in `CommandExecutor.fetchResource` resolved. If the\n * retrier resolved with type of `\"noMetadata\"`, that means the retrier got\n * preemptively stopped, as there is no point in retrying to receive metadata\n * for a message after it was confirmed to not exist. If the retrier resolved\n * with type `\"success\"`, it means that the retrier resolved with a normal\n * response.\n */\ntype RetrierResolution<T> =\n  | {\n      type: \"success\";\n      data: T;\n    }\n  | {\n      type: \"noMetadata\";\n    };\n\nclass ChannelMetadataNotFoundError extends Error {\n  public constructor(message: string) {\n    super(message);\n  }\n}\n\nclass CommandExecutor {\n  constructor(\n    private _serviceUrl: string,\n    private _services: CommandExecutorServices,\n    private _productId?: string\n  ) {}\n\n  private _preProcessUrl(url: string): string {\n    const trimmedUrl = trimSlashes(url);\n\n    if (/^https?:\\/\\//.test(url)) {\n      return trimmedUrl;\n    }\n\n    return `${trimSlashes(this._serviceUrl)}/${trimmedUrl}`;\n  }\n\n  private async _makeRequest<Request = void, Response = void>(\n    method: \"get\" | \"post\" | \"delete\",\n    url: string,\n    requestBody?: Request,\n    headers?: Record<string, string>\n  ): Promise<Result<Response>> {\n    const preProcessedUrl = this._preProcessUrl(url);\n    const finalHeaders = {\n      \"Content-Type\": \"application/json; charset=utf-8\",\n      ...(headers || {}),\n    };\n    let response: Result<Response>;\n\n    switch (method) {\n      case \"get\":\n        let getUrl = preProcessedUrl;\n\n        if (requestBody) {\n          getUrl +=\n            \"?\" +\n            Object.entries(requestBody)\n              .map((entry) => entry.map(encodeURIComponent).join(\"=\"))\n              .join(\"&\");\n        }\n\n        response = await this._services.transport.get(\n          getUrl,\n          finalHeaders,\n          this._productId\n        );\n        break;\n      case \"post\":\n        response = await this._services.transport.post(\n          preProcessedUrl,\n          finalHeaders,\n          JSON.stringify(requestBody),\n          this._productId\n        );\n        break;\n      case \"delete\":\n        response = await this._services.transport.delete(\n          preProcessedUrl,\n          finalHeaders,\n          {},\n          this._productId\n        );\n        break;\n    }\n\n    if (response.status.code < 200 || response.status.code >= 300) {\n      throw new Error(\n        `Request responded with a non-success code ${response.status.code}`\n      );\n    }\n\n    return response;\n  }\n\n  public async fetchResource<Request = void, Response = void>(\n    url: string,\n    requestBody?: Request\n  ): Promise<Response> {\n    const maxAttemptsCount = 6;\n    const retrier = new AsyncRetrier({\n      min: 50,\n      max: 1600,\n      maxAttemptsCount,\n    });\n\n    let resolution: RetrierResolution<Response>;\n\n    try {\n      resolution = await retrier.run<RetrierResolution<Response>>(async () => {\n        try {\n          const response = await this._makeRequest<Request, Response>(\n            \"get\",\n            url,\n            requestBody\n          );\n          return {\n            type: \"success\",\n            data: response.body,\n          };\n        } catch (e) {\n          // If we get the 50530 error, which signifies that the message has no\n          // metadata, we can stop the retrier by resolving it with the type\n          // `\"noMetadata\"`.\n          if (e?.body?.status === 404 && e?.body?.code === 50530) {\n            return {\n              type: \"noMetadata\",\n            };\n          }\n\n          // Any other error will be rethrown, thus continuing work of the\n          // retrier.\n          throw e;\n        }\n      });\n    } catch {\n      throw new Error(`Fetch resource from \"${url}\" failed.`);\n    }\n\n    if (resolution.type === \"noMetadata\") {\n      throw new ChannelMetadataNotFoundError(\"No metadata found.\");\n    }\n\n    return resolution.data;\n  }\n\n  public async mutateResource<Request = void, Response = void>(\n    method: \"post\" | \"delete\",\n    url: string,\n    requestBody?: Request\n  ): Promise<Response> {\n    const result = await this._makeRequest<Request, Response>(\n      method,\n      url,\n      requestBody,\n      {\n        \"X-Twilio-Mutation-Id\": uuidv4(),\n      }\n    );\n\n    if (isMutationConflictResponse(result)) {\n      return await this.fetchResource<undefined, Response>(\n        result.body.resource_url\n      );\n    }\n\n    return result.body;\n  }\n}\n\nexport { CommandExecutor, ChannelMetadataNotFoundError };\n"],"names":["AsyncRetrier","uuidv4"],"mappings":"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"}