{"version":3,"file":"configuration.js","sources":["../src/configuration.ts"],"sourcesContent":["import { ConfigurationResponse } from \"./interfaces/commands/configuration\";\nimport { parse as parseDuration, toSeconds } from \"iso8601-duration\";\nimport { Logger } from \"./logger\";\nimport { ConversationLimits } from \"./interfaces/conversation-limits\";\nimport { ClientOptions } from \"./client\";\n\nconst TYPING_TIMEOUT = 5;\nconst HTTP_CACHE_LIFETIME = \"PT5S\";\nconst CONSUMPTION_HORIZON_SENDING_INTERVAL = \"PT5S\";\nconst USER_INFOS_TO_SUBSCRIBE = 100;\n\nconst MINIMUM_RETRY_DELAY = 1000;\nconst MAXIMUM_RETRY_DELAY = 4000;\nconst MAXIMUM_ATTEMPTS_COUNT = 3;\nconst RETRY_WHEN_THROTTLED = true;\n\ninterface BackoffConfiguration {\n  min: number;\n  max: number;\n  maxAttemptsCount: number;\n}\n\nclass Configuration {\n  public readonly links: {\n    myConversations: string;\n    conversations: string;\n    users: string;\n    currentUser: string;\n    typing: string;\n    mediaService: string;\n    mediaSetService: string;\n    messagesReceipts: string;\n  };\n\n  public readonly limits: ConversationLimits;\n\n  public readonly productId?: string;\n\n  public readonly typingIndicatorTimeoutOverride?: number;\n  public readonly typingIndicatorTimeoutDefault: number = TYPING_TIMEOUT * 1000;\n  public readonly backoffConfiguration: BackoffConfiguration;\n  public readonly retryWhenThrottled: boolean;\n\n  public readonly consumptionReportInterval: number;\n  public readonly userInfosToSubscribe: number;\n  public readonly httpCacheInterval: number;\n  public readonly reachabilityEnabled: boolean;\n\n  public readonly userIdentity: string;\n  public readonly userInfo: string;\n  public readonly myConversations: string;\n\n  public readonly channelMetadataCacheCapacity: number;\n\n  constructor(\n    options: ClientOptions = {},\n    configurationResponse: ConfigurationResponse,\n    logger: Logger\n  ) {\n    const constructorOptions =\n      options.Chat || options.IPMessaging || options || {};\n\n    this.productId = constructorOptions.productId;\n\n    this.links = {\n      myConversations: configurationResponse.links.my_conversations,\n      conversations: configurationResponse.links.conversations,\n      users: configurationResponse.links.users,\n      currentUser: configurationResponse.links.current_user,\n      typing: configurationResponse.links.typing,\n      mediaService: configurationResponse.links.media_service,\n      mediaSetService: configurationResponse.links.media_set_service,\n      messagesReceipts: configurationResponse.links.messages_receipts,\n    };\n\n    this.limits = {\n      mediaAttachmentsCountLimit:\n        configurationResponse.options.media_attachments_count_limit,\n      mediaAttachmentSizeLimitInMb:\n        configurationResponse.options.media_attachment_size_limit_in_mb,\n      mediaAttachmentsTotalSizeLimitInMb:\n        configurationResponse.options.media_attachments_total_size_limit_in_mb,\n      emailHistoriesAllowedContentTypes:\n        configurationResponse.options.email_histories_allowed_mime_types,\n      emailBodiesAllowedContentTypes:\n        configurationResponse.options.email_bodies_allowed_mime_types,\n    };\n\n    this.typingIndicatorTimeoutOverride =\n      constructorOptions.typingIndicatorTimeoutOverride;\n    this.backoffConfiguration = {\n      min: MINIMUM_RETRY_DELAY,\n      max: MAXIMUM_RETRY_DELAY,\n      maxAttemptsCount: MAXIMUM_ATTEMPTS_COUNT,\n      ...constructorOptions.backoffConfigOverride,\n    };\n    this.retryWhenThrottled =\n      constructorOptions.retryWhenThrottledOverride !== undefined\n        ? constructorOptions.retryWhenThrottledOverride\n        : RETRY_WHEN_THROTTLED;\n    this.userInfosToSubscribe =\n      constructorOptions.userInfosToSubscribeOverride ??\n      configurationResponse.options.user_infos_to_subscribe ??\n      USER_INFOS_TO_SUBSCRIBE;\n    this.reachabilityEnabled =\n      configurationResponse.options.reachability_enabled;\n    this.userIdentity = configurationResponse.identity;\n    this.userInfo = configurationResponse.sync_objects.my_user_info;\n    this.myConversations = configurationResponse.sync_objects.my_conversations;\n\n    const httpCacheInterval =\n      constructorOptions.httpCacheIntervalOverride ??\n      configurationResponse.options.http_cache_interval ??\n      HTTP_CACHE_LIFETIME;\n\n    try {\n      this.httpCacheInterval = toSeconds(parseDuration(httpCacheInterval));\n    } catch {\n      logger.error(\n        `Failed to parse http cache interval ${httpCacheInterval}, using default value ${HTTP_CACHE_LIFETIME}`\n      );\n      this.httpCacheInterval = toSeconds(parseDuration(HTTP_CACHE_LIFETIME));\n    }\n\n    const consumptionReportInterval =\n      constructorOptions.consumptionReportIntervalOverride ??\n      configurationResponse.options.consumption_report_interval ??\n      CONSUMPTION_HORIZON_SENDING_INTERVAL;\n\n    try {\n      this.consumptionReportInterval = toSeconds(\n        parseDuration(consumptionReportInterval)\n      );\n    } catch {\n      logger.error(\n        `Failed to parse consumption report interval ${consumptionReportInterval}, using default value ${CONSUMPTION_HORIZON_SENDING_INTERVAL}`\n      );\n      this.consumptionReportInterval = toSeconds(\n        parseDuration(CONSUMPTION_HORIZON_SENDING_INTERVAL)\n      );\n    }\n\n    this.channelMetadataCacheCapacity =\n      options.channelMetadataCacheCapacity ?? 100;\n  }\n}\n\nexport { Configuration };\n"],"names":["toSeconds","parseDuration"],"mappings":"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"}