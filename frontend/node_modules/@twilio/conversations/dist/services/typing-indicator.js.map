{"version":3,"file":"typing-indicator.js","sources":["../../src/services/typing-indicator.ts"],"sourcesContent":["import { Logger } from \"../logger\";\n\nimport { Notifications } from \"@twilio/notifications\";\n\nimport { NotificationTypes } from \"../interfaces/notification-types\";\nimport { TwilsockClient } from \"twilsock\";\nimport { Configuration } from \"../configuration\";\nimport { Conversation } from \"../conversation\";\n\nconst log = Logger.scope(\"TypingIndicator\");\n\nexport interface TypingIndicatorServices {\n  twilsockClient: TwilsockClient;\n  notificationClient: Notifications;\n}\n\n/**\n * An important note in regards to typing timeout timers. There are two places that the SDK can get the \"typing_timeout\" attribute from. The first\n * place that the attribute appears in is the response received from POST -> /v1/typing REST call. In the body of that response, the value of the\n * \"typing_timeout\" attribute will be exactly the same as defined in the console. The second place that the attribute appears in is from a\n * notification of type \"twilio.ipmsg.typing_indicator\". In this case, the \"typing_timeout\" value will be +1 of that in the console. This\n * intentional. The timeout returned from the POST -> /v1/typing call should be used to disable further calls for that period of time. On contrary,\n * the timeout returned from the notification should be used as the timeout for the \"typingEnded\" event, +1 is to account for latency.\n *\n * @private\n */\n\n/**\n * @class TypingIndicator\n *\n * @constructor\n * @private\n */\nclass TypingIndicator {\n  private readonly services: TypingIndicatorServices;\n  private readonly configuration: Configuration;\n\n  private sentUpdates: Map<string, number>;\n  private getConversation: (conversationSid: string) => Promise<Conversation>;\n  private serviceTypingTimeout;\n\n  constructor(\n    getConversation: (conversationSid: string) => Promise<Conversation>,\n    config: Configuration,\n    services: TypingIndicatorServices\n  ) {\n    this.configuration = config;\n    this.services = services;\n    this.getConversation = getConversation;\n\n    this.serviceTypingTimeout = null;\n    this.sentUpdates = new Map();\n  }\n\n  public get typingTimeout(): number {\n    return (\n      this.configuration.typingIndicatorTimeoutOverride ||\n      this.serviceTypingTimeout ||\n      this.configuration.typingIndicatorTimeoutDefault\n    );\n  }\n\n  /**\n   * Initialize TypingIndicator controller\n   * Registers for needed message types and sets listeners\n   * @private\n   */\n  initialize(): void {\n    // this.services.notificationClient.subscribe(NotificationTypes.TYPING_INDICATOR, 'twilsock');\n    this.services.notificationClient.on(\"message\", async (type, message) => {\n      if (type === NotificationTypes.TYPING_INDICATOR) {\n        await this._handleRemoteTyping(message);\n      }\n    });\n  }\n\n  /**\n   * Remote participants typing events handler\n   */\n  private async _handleRemoteTyping(message) {\n    log.trace(\"Got new typing indicator \", message);\n\n    this.getConversation(message.channel_sid)\n      .then((conversation) => {\n        if (!conversation) {\n          return;\n        }\n\n        conversation._participants.forEach((participant) => {\n          if (participant.identity !== message.identity) {\n            return;\n          }\n\n          const timeout = this.configuration.typingIndicatorTimeoutOverride\n            ? this.configuration.typingIndicatorTimeoutOverride + 1000\n            : message.typing_timeout * 1000;\n          participant._startTyping(timeout);\n        });\n      })\n      .catch((err) => {\n        log.error(err);\n        throw err;\n      });\n  }\n\n  /**\n   * Send typing event for the given conversation sid\n   * @param {String} conversationSid\n   */\n  send(conversationSid: string) {\n    const lastUpdate = this.sentUpdates.get(conversationSid);\n    if (lastUpdate && lastUpdate > Date.now() - this.typingTimeout) {\n      return Promise.resolve();\n    }\n\n    this.sentUpdates.set(conversationSid, Date.now());\n    return this._send(conversationSid);\n  }\n\n  private _send(conversationSid: string) {\n    log.trace(\"Sending typing indicator\");\n\n    const url = this.configuration.links.typing;\n    const headers = {\n      \"Content-Type\": \"application/x-www-form-urlencoded\",\n    };\n    const body = `ChannelSid=${conversationSid}`;\n\n    return this.services.twilsockClient\n      .post<{ typing_timeout: number }>(\n        url,\n        headers,\n        body,\n        this.configuration.productId\n      )\n      .then((response) => {\n        if (response.body.hasOwnProperty(\"typing_timeout\")) {\n          this.serviceTypingTimeout = response.body.typing_timeout * 1000;\n        }\n      })\n      .catch((err) => {\n        log.error(\"Failed to send typing indicator:\", err);\n        throw err;\n      });\n  }\n}\n\nexport { TypingIndicator };\n"],"names":["Logger","NotificationTypes"],"mappings":"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"}